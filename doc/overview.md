# PHook - PHP関数フック拡張機能

## 概要

PHookは、PHP関数/メソッドを傍受する強力な機能を提供するPHP拡張機能です。PHP 8のZend Observerシステムを活用して、任意のPHP関数やメソッド呼び出しにフックを設定し、実行前および実行後のコールバックを可能にします。

この拡張機能は、元々OpenTelemetry PHP計装の一部として開発されましたが、OpenTelemetry固有の機能を除去し、スタンドアロンの関数フック機構として提供するよう修正されています。

## 主な機能

- 任意のPHP関数やメソッドに実行前および実行後のコールバックをフック
- 実行前の関数パラメータを変更
- 実行後の戻り値を変更
- 静的メソッド、インスタンスメソッド、関数のフックをサポート
- PHP 8以上の属性ベースのフックをサポート
- パラメータのキャプチャと操作をサポート
- アプリケーションがクラッシュしないようにフック内での例外処理
- 登録済みフックの効率的なハッシュベースのルックアップ

## 要件

- PHP 8.0以上
- 拡張機能をビルドするためのPHP開発ヘッダーとツール

## アーキテクチャ概要

この拡張機能はPHP 8のZend Observerメカニズムに基づいており、以下の主要コンポーネントで構成されています：

1. **フック登録**: コールバックを登録するためのコア`hook()`関数
2. **オブザーバーシステム**: Zend EngineのオブザーバーAPIとの統合
3. **パラメータ処理**: 関数パラメータへのアクセスと変更のためのユーティリティ
4. **戻り値処理**: 戻り値を傍受して変更するためのインフラストラクチャ
5. **属性サポート**: 宣言的なフックのためのPHP 8属性

この拡張機能は、関数やメソッドに登録されたフックを効率的に追跡・管理するための内部ハッシュテーブルを維持します。フックされた関数が呼び出されると、拡張機能はその呼び出しを傍受し、登録された実行前フックを実行し、元の関数を実行させ、その後登録された実行後フックを実行します。